format_version: 2
common:
  storeProperty: &storeProps |
      curl --insecure -u ${user}:${password} -d "value=1.1.1" -X POST -H 'Confirm: true' ${GO_SERVER_URL}/properties/{$GO_PIPELINE_NAME}/${GO_PIPELINE_COUNTER}/${GO_STAGE_NAME}/${GO_STAGE_COUNTER}/${GO_JOB_NAME}/version
      echo "#{theName} PLAN!"
  parent: &parent
    Apipeline:
      pipeline: A
      stage: apply
  plan: &plan
    clean_workspace: true
    secure_variables: 
      user: "90mE/w2Ux+xlqFipNLdINA=="
      password: "8sXkDq7gmd56t2NnkJExsg=="
    jobs:
      plan:
        tasks:
        - script: |
            echo "#{theName} PLAN!"
        - script: *storeProps          
  apply: &apply
    approval:
      type: manual # Require someone in the UI to manually approve the execution of this stage
      users:
        - superman
    clean_workspace: true
    jobs:
      apply:
        tasks:
        - script: |
            echo "APPLY!"
  materials: &materials
    thing:
      branch: master
      git: https://github.com/plainsane/gogogadgetcd-material.git
      destination: repo
  basePipeline: &basePipeline
    materials:
      <<: *materials
      <<: *parent
    stages:
      - plan:
          <<: *plan
      - apply:
          <<: *apply

pipelines:
  A:
    tag: master
    group: GOgogadgetCD
    parameters:
      theName: A
    materials:
      <<: *materials
    stages:
      - plan:
          <<: *plan
      - apply:
          <<: *apply
  B:
    group: GOgogadgetCD
    parameters:
      theName: B
    <<: *basePipeline
  C:
    group: GOgogadgetCD
    parameters:
      theName: C
    <<: *basePipeline
